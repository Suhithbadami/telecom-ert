<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Call History</title>
    <style>
        /* Optional: Add some styling to the buttons for better visibility */
        button {
            margin-right: 10px;
        }

        body {
            background-color: #4B0082 !important;
            color: white !important;
            min-height: 70vh;
            padding-top: 1px;
        }
    </style>
    <script>
        function filterCalls(callType) {
            var rows = document.querySelectorAll('.call-row');

            rows.forEach(function (row) {
                var type = row.children[1].textContent.trim();

                if (callType.toLowerCase() === 'all' || type.toLowerCase() === callType.toLowerCase()) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });

            // Store the filter selection in local storage
            localStorage.setItem('callFilter', callType);
        }

        function updateDateTime() {
            var rows = document.querySelectorAll('.call-row');

            rows.forEach(function (row) {
                var callDateElement = row.querySelector('.call-date');
                var startTimeElement = row.querySelector('.start-time');
                var endTimeElement = row.querySelector('.end-time');
                var callDurationElement = row.querySelector('.call-duration');

                // Get the current date and time
                var now = new Date();
                var formattedDate = now.toLocaleDateString();
                var formattedTime = formatTime(now);

                callDateElement.textContent = formattedDate;
                startTimeElement.textContent = formattedTime;

                // Get the call duration from the element content
                var callDurationString = callDurationElement.textContent;
                var { minutes, seconds } = parseCallDuration(callDurationString);

                // Calculate end time based on call duration
                var callDurationMilliseconds = (minutes * 60 + seconds) * 1000;
                var endTime = new Date(now.getTime() + callDurationMilliseconds);

                // Format and set the end time in the element
                endTimeElement.textContent = formatTime(endTime);
            });
        }

        function parseCallDuration(durationString) {
            var match = durationString.match(/(\d+)min(\d+)sec/);
            if (match) {
                var minutes = parseInt(match[1]);
                var seconds = parseInt(match[2]);
                return { minutes, seconds };
            } else {
                var matchMinutes = durationString.match(/(\d+)min/);
                if (matchMinutes) {
                    var minutes = parseInt(matchMinutes[1]);
                    return { minutes, seconds: 0 };
                } else {
                    return { minutes: 0, seconds: 0 };
                }
            }
        }

        function formatTime(date) {
            var hours = date.getHours();
            var minutes = date.getMinutes();
            var seconds = date.getSeconds();

            minutes = minutes < 10 ? '0' + minutes : minutes;
            seconds = seconds < 10 ? '0' + seconds : seconds;

            return hours + ':' + minutes + ':' + seconds;
        }

        window.onload = function () {
            updateDateTime();
            // Retrieve the filter selection from local storage
            var storedFilter = localStorage.getItem('callFilter');
            if (storedFilter) {
                filterCalls(storedFilter);
            }
        };

        document.addEventListener('DOMContentLoaded', function () {
            updateDateTime();
            // Retrieve the filter selection from local storage
            var storedFilter = localStorage.getItem('callFilter');
            if (storedFilter) {
                filterCalls(storedFilter);
            }
        });
    </script>
</head>
<body>
<h1>Call History</h1>
<div>
    <button onclick="filterCalls('All')">All</button>
    <button onclick="filterCalls('Incoming')">Incoming</button>
    <button onclick="filterCalls('Outgoing')">Outgoing</button>
</div>

<table>
    <tr>
        <th>id</th>
        <th>Call Type</th>
        <th>Call Date</th>
        <th>Call Duration</th>
        <th>Mobile Number</th>
        <th>Start Time</th>
        <th>End Time</th>
    </tr>
    <tr th:each="callHistory : ${callHistoryList}" data-call-type="${callHistory.callType}" class="call-row">
        <td th:text="${callHistory.id}"></td>
        <td th:text="${callHistory.callType}"></td>
        <td class="call-date"></td>
        <td class="call-duration" th:text="${callHistory.callDuration}"></td>
        <td th:text="${callHistory.mobileNumber}"></td>
        <td class="start-time"></td>
        <td class="end-time"></td>
    </tr>
</table>
</body>
</html>
